<!DOCTYPE html>
<html>
<head>
    <title>CSVision</title>
    <!-- Add Google Fonts - Inter is modern and highly readable -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Colors */
            --button-default: #c0c0c0;
            --button-hover: #867e7e;
            --bright-green: #7AC7A3;
            --bright-blue: #81abd5;
            --bright-orange: #e7a2b1;
            --active-green: #4CAF8A;
            --active-blue: #5596d7;
            --active-orange: #ea5f7d;
            --muted-green: #A8D5BE;
            --muted-blue: #81abd5;
            --muted-orange: #e7a2b1;
            --hover-green: #90DFB8;
            --hover-blue: #5596d7;
            --hover-orange: #ea5f7d;
            
            /* Neutral colors */
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --border-light: #e2e8f0;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
        }

        * {
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            border-left: 1px solid var(--border-light);
            border-right: 1px solid var(--border-light);
            min-height: 100vh;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .app-header {
            text-align: center;
            margin: 40px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px;  /* Increased gap slightly */
        }

        .app-logo {
            width: 65px;  /* Increased from 50px */
            height: 65px;  /* Increased from 50px */
            object-fit: contain;
        }

        .app-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.8em;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
            text-transform: uppercase;
            background: linear-gradient(120deg, #2c3e50, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            margin: 0;
        }

        .app-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;  /* Increased from 60px */
            height: 4px;
            background: linear-gradient(90deg, #2c3e50, #3498db);
            border-radius: 2px;
        }

        .container, .stats-container, .template-box, .log-container, .analysis-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .container:hover, .stats-container:hover, .template-box:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .steps {
            display: flex;
            justify-content: center;
            margin: 40px 0;
            gap: 30px;
        }

        .step {
            padding: 12px 24px;
            background: var(--button-default);
            border-radius: 2px;
            font-size: 0.95em;
            font-weight: 500;
            color: white;
            position: relative;
        }

        .step::after {
            content: '';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            border-top: 2px solid var(--border-light);
            border-right: 2px solid var(--border-light);
            transform: translateY(-50%) rotate(45deg);
        }

        .step:last-child::after {
            display: none;
        }

        .mode-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 40px 0;
            padding: 20px;
            background: linear-gradient(to right, rgba(255,255,255,0.5), rgba(255,255,255,0.8), rgba(255,255,255,0.5));
            border-radius: 16px;
        }

        .mode-button {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: white;
            opacity: 1;
            position: relative;
            overflow: hidden;
        }

        .mode-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255,255,255,0.1), rgba(255,255,255,0));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mode-button:hover::before {
            opacity: 1;
        }

        .settings-top {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .settings-top label {
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }

        input, select, textarea {
            font-family: 'Inter', sans-serif;
            padding: 10px 12px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 0.95em;
            transition: all 0.2s ease;
            width: 100%;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--bright-blue);
            box-shadow: 0 0 0 3px rgba(129, 171, 213, 0.2);
        }

        .preview-box {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .preview-content {
            background: var(--bg-primary);
            padding: 16px;
            border-radius: 8px;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .settings {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .toggle-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 20px 0;
        }
        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 2px;  /* More rectangular */
            cursor: pointer;
            background-color: var(--button-default);
            color: white;
        }
        .button:hover {
            background-color: var(--button-hover);
        }
        select, input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        textarea {
            width: 100%;
            min-height: 150px;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .step-container {
            text-align: center;
            padding: 40px;
            background: #f5f5f5;
            border-radius: 8px;
            margin: 40px auto;
            max-width: 600px;
        }
        .step-container button {
            margin-top: 20px;  /* Add space above buttons */
        }
        .step-container select {
            margin-bottom: 20px;  /* Add space below dropdown */
        }
        .error-message {
            color: #d32f2f;
            margin: 10px 0;
            display: none;
        }
        .steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .step {
            padding: 10px 20px;
            margin: 0 10px;
            background: var(--button-default);
            border-radius: 2px;  /* More rectangular */
            font-size: 0.9em;
            color: white;
        }
        .step.active {
            background: var(--button-hover);
        }
        .step.completed {
            background: var(--button-default);
            opacity: 0.8;
        }
        .stats-container {
            margin: 20px 0;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .stat-box {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .stat-box h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .stat-box p {
            margin: 5px 0;
            color: #495057;
        }
        
        .model-cost {
            margin: 10px 0;
            padding: 10px;
            background: #fff;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        
        .model-cost h5 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }
        
        .cost-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .cost-section {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
        }
        
        .cost-section h6 {
            margin: 0 0 5px 0;
            color: #2c3e50;
            font-size: 0.9em;
        }
        
        .cost-section p {
            margin: 3px 0;
            font-size: 0.9em;
        }
        
        .total-cost {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
            text-align: right;
        }
        
        .total-cost p {
            margin: 5px 0;
        }
        
        select {
            font-size: 0.9em;
            padding: 8px;
        }

        .content-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
            min-height: 600px;
        }

        .preview-box {
            display: flex;
            flex-direction: column;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: auto;
        }

        .preview-content {
            display: none;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            height: 600px;  /* Doubled from 300px to 600px */
            overflow-y: auto;
            font-size: 0.9em;
            border: 1px solid #e9ecef;
        }

        .preview-content.active {
            display: block;
        }

        .prompt-preview .preview-content {
            display: block;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab-button {
            padding: 8px 16px;
            border: none;
            border-radius: 2px;  /* More rectangular */
            background: var(--button-default);
            color: white;
            cursor: pointer;
        }

        .tab-button:hover {
            background: var(--button-hover);
        }

        .tab-button.active {
            background: var(--button-hover);
        }

        .template-controls {
            margin-bottom: 15px;
        }

        .prompt-preview {
            margin-top: 20px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .preview-content .csv-data {
            font-style: italic;
            color: #4CAF50;
        }

        .settings-top {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: start;
        }

        .settings-top > div {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .settings-top label {
            font-weight: 500;
            color: #2c3e50;
        }

        .settings-top input,
        .settings-top select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .settings-top .button {
            align-self: flex-start;
            margin-top: 5px;
        }

        .settings-top .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .settings-top .input-group input {
            flex: 1;
        }

        .csv-file-display {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .csv-file-name {
            font-family: monospace;
            color: #2c3e50;
        }

        .right-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .flow-arrow {
            position: relative;
            height: 60px;  /* Increased height */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4CAF50;
            font-size: 36px;  /* Larger font size */
            margin: 10px 0;
        }

        .flow-arrow::after {
            content: '↓';
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);  /* Add shadow */
            animation: float 2s ease-in-out infinite;  /* Add floating animation */
        }

        .horizontal-arrow {
            position: absolute;
            left: -50px;  /* Move further out */
            top: 50%;
            transform: translateY(-50%);
            color: #4CAF50;
            font-size: 36px;  /* Larger font size */
            width: 50px;  /* Fixed width */
            height: 50px;  /* Fixed height */
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);  /* Add shadow */
            animation: pulse 2s ease-in-out infinite;  /* Add pulse animation */
        }

        .horizontal-arrow::after {
            content: '→';
            font-weight: bold;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes pulse {
            0%, 100% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.1); }
        }

        /* Custom scrollbar styling */
        .preview-content::-webkit-scrollbar {
            width: 8px;
        }

        .preview-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .preview-content::-webkit-scrollbar-thumb {
            background: var(--button-default);
            border-radius: 4px;
        }

        .preview-content::-webkit-scrollbar-thumb:hover {
            background: var(--button-hover);
        }

        .mode-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 30px 0;
        }

        .mode-button {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: white;
            opacity: 1;
            background-color: var(--button-default);
        }

        .mode-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            background-color: var(--button-hover);
        }

        .mode-button.active {
            background-color: var(--button-hover);
            opacity: 1;
        }

        .process-button-container {
            display: flex;
            justify-content: center;
            margin: 40px 0;
        }

        .process-button {
            padding: 20px 40px;
            font-size: 1.2em;
            background-color: var(--button-default);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .process-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            background-color: var(--button-hover);
        }

        .process-button.classify-mode {
            background-color: #81abd5;
        }

        .process-button.classify-mode:hover {
            background-color: #5596d7;
        }

        .template-box {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .log-container {
            margin: 20px 0;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .log-container h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        #log-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        #log-content div {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #e9ecef;
        }

        #log-content a {
            color: #2196F3;
            text-decoration: none;
        }

        #log-content a:hover {
            text-decoration: underline;
        }

        #log-content span {
            margin-right: 8px;
            font-weight: bold;
        }

        .analysis-container {
            display: none;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .analysis-container.active {
            display: block;
        }

        .column-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .column-list {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            min-height: 200px;
        }

        .column-list h4 {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 1.1em;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-light);
        }

        .column-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin: 8px 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .column-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        .column-item.selected {
            background: #e8f4ff;
            border-color: var(--bright-blue);
            color: var(--text-primary);
        }

        .column-item input[type="checkbox"],
        .column-item input[type="radio"] {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
            accent-color: var(--bright-blue);
        }

        .column-item label {
            flex: 1;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #analysis-container {
            padding: 30px;
            margin: 40px 0;
        }

        #analysis-container h2 {
            color: var(--text-primary);
            font-size: 1.5em;
            font-weight: 600;
            margin: 0 0 30px 0;
            text-align: center;
        }

        .analysis-button {
            display: block;
            margin: 40px auto 20px;
            padding: 14px 40px;
            font-size: 1.1em;
            font-weight: 500;
            background-color: var(--bright-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .analysis-button:hover:not(:disabled) {
            background-color: var(--active-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .analysis-button:disabled {
            background-color: #e2e8f0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Add a subtle scroll effect for many variables */
        #predictor-columns,
        #outcome-columns {
            max-height: none;
            overflow-y: visible;
        }

        /* Scrollbar styling */
        #predictor-columns::-webkit-scrollbar,
        #outcome-columns::-webkit-scrollbar {
            width: 8px;
        }

        #predictor-columns::-webkit-scrollbar-track,
        #outcome-columns::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 4px;
        }

        #predictor-columns::-webkit-scrollbar-thumb,
        #outcome-columns::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        #predictor-columns::-webkit-scrollbar-thumb:hover,
        #outcome-columns::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .loading-spinner.active {
            display: block;
        }

        .loading-spinner::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pearson-correlation {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pearson-bar {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .pearson-label {
            width: 200px;
            font-weight: bold;
        }

        .pearson-value {
            width: 80px;
            text-align: right;
            font-family: monospace;
        }

        .pearson-bar-graph {
            flex-grow: 1;
            margin: 0 20px;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .pearson-bar-fill {
            height: 100%;
            position: absolute;
            left: 0;  /* Changed from 50% to 0 */
            transform: none;  /* Removed translateX */
            transition: width 0.3s ease;
        }

        .pearson-bar-fill.positive {
            background: rgba(76, 175, 80, 0.6);
            border-right: 2px solid #4CAF50;
        }

        .pearson-bar-fill.negative {
            background: rgba(244, 67, 54, 0.6);
            border-right: 2px solid #f44336;
        }

        /* Summarization mode */
        .mode-button[onclick*="'summarize'"] {
            background-color: var(--muted-green);
        }
        .mode-button[onclick*="'summarize'"]:hover {
            background-color: var(--hover-green);
            opacity: 1;
        }
        .mode-button[onclick*="'summarize'"].active {
            background-color: var(--active-green);
            opacity: 1;
        }

        /* Classification mode */
        .mode-button[onclick*="'classify'"] {
            background-color: #81abd5;
        }
        .mode-button[onclick*="'classify'"]:hover {
            background-color: #5596d7;
            opacity: 1;
        }
        .mode-button[onclick*="'classify'"].active {
            background-color: #5596d7;
            opacity: 1;
        }

        /* Analysis mode */
        .mode-button[onclick*="'analyze'"] {
            background-color: var(--muted-orange);
        }
        .mode-button[onclick*="'analyze'"]:hover {
            background-color: var(--hover-orange);
            opacity: 1;
        }
        .mode-button[onclick*="'analyze'"].active {
            background-color: var(--active-orange);
            opacity: 1;
        }

        /* Process buttons should match their mode colors */
        .mode-button[onclick*="'summarize'"].active ~ .process-button-container #process-button {
            background-color: var(--active-green);
        }
        .mode-button[onclick*="'classify'"].active ~ .process-button-container #process-button {
            background-color: #5596d7;
        }

        .process-button {
            background-color: var(--active-green);
        }
        .process-button:hover {
            background-color: var(--hover-green);
        }
        .process-button.classify-mode {
            background-color: #81abd5;
        }
        .process-button.classify-mode:hover {
            background-color: #5596d7;
        }

        /* Add transition for smooth color changes */
        .mode-button, .button, .tab-button {
            transition: all 0.3s ease;
        }

        /* Ensure non-active mode buttons and their process buttons stay muted */
        body[data-active-mode="summarize"] .mode-button:not([onclick*="'summarize'"]),
        body[data-active-mode="classify"] .mode-button:not([onclick*="'classify'"]),
        body[data-active-mode="analyze"] .mode-button:not([onclick*="'analyze'"]) {
            opacity: 0.7;
        }

        /* Add scrollbar styling for log content */
        #log-content::-webkit-scrollbar {
            width: 8px;
        }

        #log-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        #log-content::-webkit-scrollbar-thumb {
            background: var(--button-default);
        }

        #log-content::-webkit-scrollbar-thumb:hover {
            background: var(--button-hover);
        }

        /* Analysis Results Sections */
        .analysis-section {
            display: none;  /* Hide by default */
            margin-top: 40px;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .analysis-section h3 {
            color: var(--text-primary);
            font-size: 1.3em;
            font-weight: 600;
            margin: 0 0 20px 0;
        }

        /* Show sections when results are active */
        .analysis-results.active .analysis-section {
            display: block;
        }

        .scatter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .scatter-plot {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .scatter-controls {
            margin-bottom: 15px;
        }

        .loess-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .loess-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Add to existing styles */
        .help-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            font-weight: 500;
            margin-left: auto;
        }

        .help-button:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 40px auto;
            padding: 0;
            width: 90%;
            max-width: 800px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.5em;
        }

        .close-modal {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0 8px;
        }

        .close-modal:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .instruction-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-light);
        }

        .instruction-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .instruction-section h3 {
            color: var(--text-primary);
            margin: 0 0 16px 0;
            font-size: 1.2em;
        }

        .instruction-section p {
            margin: 8px 0;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .instruction-section ul {
            margin: 8px 0;
            padding-left: 24px;
            color: var(--text-secondary);
        }

        .instruction-section li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .instruction-section code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .instruction-section a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
        }

        .instruction-section a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="app-header">
        <img src="{{ url_for('static', filename='images/csvision-logo.png') }}" alt="CSVision Logo" class="app-logo">
        <h1 class="app-title">CSVision</h1>
        <button onclick="showInstructions()" class="help-button">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12" y2="17"></line>
            </svg>
            Instructions
        </button>
    </div>

    <!-- Instructions Modal -->
    <div id="instructionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📚 CSVision Instructions</h2>
                <span class="close-modal" onclick="hideInstructions()">&times;</span>
            </div>
            <div class="modal-body">
                <section class="instruction-section">
                    <h3>🚀 Getting Started</h3>
                    <ul>
                        <li>Upload a CSV file containing your text data</li>
                        <li>Select the column you want to analyze</li>
                        <li>Choose between Summarization, Classification, or Analysis mode</li>
                    </ul>
                </section>

                <section class="instruction-section">
                    <h3>📊 Sample Data</h3>
                    <p>You can find sample CSV files in the <a href="https://github.com/yangong17/STATS418_CSVision/tree/main/samplecsvs" target="_blank">GitHub repository's samplecsvs folder</a>:</p>
                    <ul>
                        <li><strong>testsample.csv</strong>: Used for testing the summarization feature
                            <ul>
                                <li>Select "text" as the column to process</li>
                                <li>Use "Trip Report Analysis" prompt template</li>
                            </ul>
                        </li>
                        <li><strong>summarizedsample.csv</strong>: Used for testing the classification feature
                            <ul>
                                <li>Select "Summary" as the column to process</li>
                                <li>Use "Trip Report Classification" prompt template</li>
                            </ul>
                        </li>
                        <li><strong>classified_sample_full.csv</strong>: Used for testing the analysis feature
                            <ul>
                                <li>⚠️ Contains 570 entries - avoid running analysis/classification to preserve API credits</li>
                                <li>In Analysis mode, select predictor and outcome variables</li>
                            </ul>
                        </li>
                    </ul>
                </section>

                <section class="instruction-section">
                    <h3>🔑 API Key Information</h3>
                    <p>The default API key is linked to a demo account with limited credits (~$3 remaining as of 6/2/2025).</p>
                    <p>To use your own OpenAI API key:</p>
                    <ul>
                        <li>Enter it directly in the dashboard's API Key field, or</li>
                        <li>Modify the <code>.env</code> file in the project root</li>
                    </ul>
                    <p><em>Note: Get your API key from the <a href="https://platform.openai.com/account/api-keys" target="_blank">OpenAI dashboard</a></em></p>
                </section>

                <section class="instruction-section">
                    <h3>📖 Additional Resources</h3>
                    <ul>
                        <li><a href="https://github.com/yangong17/STATS418_CSVision" target="_blank">Full Documentation on GitHub</a></li>
                    </ul>
                </section>
            </div>
        </div>
    </div>

    <!-- Progress Steps -->
    <div class="steps">
        <div class="step {% if step == 'upload' %}active{% elif step in ['select_column', 'dashboard'] %}completed{% endif %}">
            1. Upload CSV
        </div>
        <div class="step {% if step == 'select_column' %}active{% elif step == 'dashboard' %}completed{% endif %}">
            2. Select Column
        </div>
        <div class="step {% if step == 'dashboard' %}active{% endif %}">
            3. Configure & Process
        </div>
    </div>

    {% if step == 'upload' %}
    <div class="step-container">
        <h2>Upload CSV File</h2>
        <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
            <input type="file" name="csv_file" accept=".csv" required>
            <button type="submit" class="button">Upload</button>
        </form>
    </div>
    {% endif %}

    {% if step == 'select_column' %}
    <div class="step-container">
        <h2>Select Column to Process</h2>
        <select id="column-select">
            {% for column in columns %}
            <option value="{{ column }}">{{ column }}</option>
            {% endfor %}
        </select>
        <button onclick="updateColumn()" class="button">Continue</button>
    </div>
    {% endif %}

    {% if step == 'dashboard' %}
    <!-- Top Section: API Key and Model Selection -->
    <div class="settings-top">
        <div>
            <label>API Key:</label>
            <div class="input-group">
                <input type="text" id="api-key" value="{{ api_key }}" placeholder="Enter OpenAI API Key">
                <button onclick="updateApiKey()" class="button">Update API Key</button>
                {% if connection_error %}
                <div class="error-message">{{ error_message }}</div>
                {% endif %}
            </div>
        </div>
        <div>
            <label>Current CSV File:</label>
            <div class="csv-file-display">
                <span class="csv-file-name">{{ session.get('csv_path', '').split('/')[-1] }}</span>
                <input type="file" id="csv-file" accept=".csv" style="display: none;">
                <button onclick="document.getElementById('csv-file').click()" class="button">Change File</button>
            </div>
        </div>
        <div>
            <label>Column:</label>
            <div class="input-group">
                <select id="column-select" onchange="updateColumn()">
                    {% for column in columns %}
                    <option value="{{ column }}" {% if column == selected_column %}selected{% endif %}>{{ column }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div>
            <label>Model:</label>
            <select id="model-select" onchange="updateModel()">
                {% for model_id, info in models.items() %}
                <option value="{{ model_id }}" {% if model == model_id %}selected{% endif %}>
                    {{ info.display_name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Mode Selection -->
    <div class="mode-buttons">
        <button class="mode-button {% if session.get('mode', 'summarize') == 'summarize' %}active{% endif %}" 
                onclick="updateMode('summarize')">Summarization Mode</button>
        <button class="mode-button {% if session.get('mode') == 'classify' %}active{% endif %}" 
                onclick="updateMode('classify')">Classification Mode</button>
        <button class="mode-button {% if session.get('mode') == 'analyze' %}active{% endif %}" 
                onclick="updateMode('analyze')">Analysis Mode</button>
    </div>

    <!-- Analysis Interface -->
    <div id="analysis-container" class="analysis-container {% if session.get('mode') == 'analyze' %}active{% endif %}">
        <h2>Select Variables for Analysis</h2>
        <div class="column-selection">
            <div class="column-list">
                <h4>Predictor Variables</h4>
                <div id="predictor-columns">
                    {% for column in columns %}
                    <div class="column-item" onclick="togglePredictorColumn(this, '{{ column }}')">
                        <input type="checkbox" id="pred-{{ column }}" value="{{ column }}">
                        <label for="pred-{{ column }}">{{ column }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="column-list">
                <h4>Outcome Variable</h4>
                <div id="outcome-columns">
                    {% for column in columns %}
                    <div class="column-item" onclick="toggleOutcomeColumn(this, '{{ column }}')">
                        <input type="radio" name="outcome" id="out-{{ column }}" value="{{ column }}">
                        <label for="out-{{ column }}">{{ column }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <button id="analyze-button" class="analysis-button" onclick="runAnalysis()" disabled>Run Analysis</button>
        
        <!-- Loading Spinner -->
        <div id="analysis-loading" class="loading-spinner">
            Analyzing data...
        </div>
        
        <!-- Analysis Results -->
        <div id="analysis-results" class="analysis-results">
            <div class="analysis-section">
                <h3>Pearson Correlation with Outcome</h3>
                <div id="pearson-correlation" class="pearson-correlation"></div>
            </div>
            
            <div class="analysis-section">
                <h3>Full Correlation Matrix</h3>
                <div id="correlation-table"></div>
            </div>
            
            <div class="analysis-section">
                <h3>Distribution Analysis</h3>
                <div id="distribution-grid" class="distribution-grid"></div>
            </div>

            <div class="analysis-section">
                <h3>Scatter Plots with Outcome Variable</h3>
                <div class="scatter-controls">
                    <label class="loess-toggle">
                        <input type="checkbox" id="show-loess" onchange="toggleLoessLines()">
                        Show LOESS Trend Lines
                    </label>
                </div>
                <div id="scatter-grid" class="scatter-grid"></div>
            </div>
        </div>
    </div>

    <!-- Regular Interface (Stats, Template, Preview) -->
    <div id="regular-container" style="display: {% if session.get('mode') == 'analyze' %}none{% else %}block{% endif %}">
        <!-- Dataset Stats -->
        <div class="stats-container">
            <h2>Dataset Statistics</h2>
            {% if stats %}
            <div class="stats-grid">
                <div class="stat-box">
                    <h4>Basic Stats</h4>
                    <p>Total Rows: {{ stats.row_count }}</p>
                    <p>Average Characters: {{ stats.mean_chars }}</p>
                    <p>Median Characters: {{ stats.median_chars }}</p>
                    <p>Total Characters: {{ stats.total_chars }}</p>
                </div>
                
                {% for model, cost in stats.costs.items() %}
                <div class="stat-box model-cost">
                    <h5>{{ cost.display_name }}</h5>
                    <div class="cost-grid">
                        <div class="cost-section">
                            <h6>Input Costs (per 1M tokens)</h6>
                            <p>Regular: ${{ "%.2f"|format(cost.input_price) }}</p>
                            <p>Cached: ${{ "%.2f"|format(cost.cached_input_price) }}</p>
                        </div>
                        <div class="cost-section">
                            <h6>Output Cost (per 1M tokens)</h6>
                            <p>${{ "%.2f"|format(cost.output_price) }}</p>
                        </div>
                    </div>
                    <div class="total-cost">
                        <p>Total Cost (Regular): ${{ cost.estimated_total_cost }}</p>
                        <p>Total Cost (Cached): ${{ cost.estimated_total_cost_cached }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Content Layout -->
        <div class="content-layout">
            <!-- Left Side: Column Preview with Tabs -->
            <div class="preview-box">
                <h3>CSV Data Preview</h3>
                <div class="tabs">
                    {% for i in range(5) %}
                    <button class="tab-button {% if loop.first %}active{% endif %}" onclick="showTab({{ i }})">Entry {{ i + 1 }}</button>
                    {% endfor %}
                </div>
                {% if preview_data %}
                    {% for i in range(5) %}
                    <div class="preview-content {% if loop.first %}active{% endif %}" id="tab-{{ i }}">
                        {{ preview_data[i] if preview_data|length > i else 'No data available' }}
                    </div>
                    {% endfor %}
                {% endif %}
            </div>

            <!-- Right Side: Template and Preview -->
            <div class="right-column">
                <!-- Template Box -->
                <div class="template-box">
                    <h3>Prompt Template</h3>
                    <div class="horizontal-arrow"></div>
                    <div class="template-controls">
                        <select id="template-select" onchange="updatePromptTemplate()">
                            {% if session.get('mode') == 'classify' %}
                                {% for key, template in sample_prompts.classification.items() %}
                                <option value="classification.{{ key }}">
                                    {{ template.name }}
                                </option>
                                {% endfor %}
                            {% else %}
                                {% for key, template in sample_prompts.summarization.items() %}
                                <option value="summarization.{{ key }}">
                                    {{ template.name }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <textarea id="custom-prompt">{{ prompt_template }}</textarea>
                </div>

                <!-- Flow Arrow -->
                <div class="flow-arrow"></div>

                <!-- Preview Box -->
                <div class="prompt-preview">
                    <h3>Full Prompt Preview</h3>
                    <div class="preview-content">
                        {{ prompt_preview|replace(preview_data[0] if preview_data else '', '<span class="csv-data">' + (preview_data[0] if preview_data else '') + '</span>')|safe if prompt_preview else 'No preview available' }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Process Button -->
        <div class="process-button-container">
            <button id="process-button" class="process-button {% if session.get('mode') == 'classify' %}classify-mode{% endif %}" onclick="processData('{% if session.get('mode') == 'classify' %}classify{% else %}summarize{% endif %}')">
                {% if session.get('mode') == 'classify' %}Classify Data{% else %}Summarize Data{% endif %}
            </button>
        </div>

        <!-- Processing Log -->
        <div class="log-container">
            <h3>Processing Log</h3>
            <div id="log-content"></div>
        </div>
    </div>
    {% endif %}

    <script>
        var TEMPLATES = {{ sample_prompts|tojson|safe }};

        var selectedPredictors = new Set();
        var selectedOutcome = null;

        function updateApiKey() {
            const apiKey = document.getElementById('api-key').value;
            fetch('/update_api_key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Error updating API key: ' + data.message);
                }
            });
        }

        function updateModel() {
            const model = document.getElementById('model-select').value;
            fetch('/update_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ model: model })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (data.stats) {
                        updateStats(data.stats);
                    }
                } else {
                    alert('Error updating model: ' + data.message);
                }
            });
        }

        function updateMode(mode) {
            fetch('/update_mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ mode: mode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // If switching from analyze mode to another mode, do a full page reload
                    const currentMode = document.querySelector('.mode-button.active').textContent.toLowerCase().includes('analysis') ? 'analyze' : 
                                      document.querySelector('.mode-button.active').textContent.toLowerCase().includes('classify') ? 'classify' : 'summarize';
                    
                    if (currentMode === 'analyze' && mode !== 'analyze') {
                        location.reload();
                        return;
                    }
                    
                    // Update mode button styling
                    document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelector(`.mode-button[onclick="updateMode('${mode}')"]`).classList.add('active');
                    
                    // Update process button class and text
                    const processButton = document.getElementById('process-button');
                    if (processButton) {
                        if (mode === 'classify') {
                            processButton.classList.add('classify-mode');
                        } else {
                            processButton.classList.remove('classify-mode');
                        }
                        processButton.textContent = mode === 'classify' ? 'Classify Data' : 'Summarize Data';
                        processButton.onclick = function() { processData(mode); };
                    }
                    
                    // Show/hide appropriate containers
                    var analysisContainer = document.getElementById('analysis-container');
                    var regularContainer = document.getElementById('regular-container');
                    
                    if (mode === 'analyze') {
                        analysisContainer.style.display = 'block';
                        regularContainer.style.display = 'none';
                    } else {
                        analysisContainer.style.display = 'none';
                        regularContainer.style.display = 'block';
                        
                        // Update template select options based on mode
                        var templateSelect = document.getElementById('template-select');
                        templateSelect.innerHTML = '';
                        
                        // Add new options based on mode
                        var modeTemplates = mode === 'classify' ? TEMPLATES.classification : TEMPLATES.summarization;
                        for (var key in modeTemplates) {
                            var template = modeTemplates[key];
                            var option = document.createElement('option');
                            option.value = mode === 'classify' ? 'classification.' + key : 'summarization.' + key;
                            option.textContent = template.name;
                            templateSelect.appendChild(option);
                        }
                        
                        // Set first template as selected and update
                        if (templateSelect.options.length > 0) {
                            templateSelect.selectedIndex = 0;
                            updatePromptTemplate();
                        }
                    }
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                alert('Failed to update mode. Please try again.');
            });
        }

        function updateColumn() {
            const column = document.getElementById('column-select').value;
            const select = document.getElementById('column-select');
            
            // Disable the select while processing
            select.disabled = true;
            
            if (!column) {
                console.error('No column selected');
                alert('Please select a column first');
                select.disabled = false;
                return;
            }
            
            fetch('/update_column', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ column: column })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    console.log('Column updated successfully:', data.message);
                    location.reload();
                } else {
                    throw new Error(data.message || 'Unknown error occurred');
                }
            })
            .catch(error => {
                console.error('Error updating column:', error);
                alert('Failed to update column: ' + error.message);
                select.disabled = false;
            });
        }

        function processData(mode) {
            const processButton = document.getElementById('process-button');
            const logContent = document.getElementById('log-content');
            const customPrompt = document.getElementById('custom-prompt').value;
            const originalSummarizeText = processButton.textContent;
            
            // Disable buttons during processing
            processButton.disabled = true;
            
            // Clear previous log
            logContent.innerHTML = '';
            
            // Create EventSource for server-sent events
            const params = new URLSearchParams({
                custom_prompt: customPrompt,
                mode: mode
            });
            
            const eventSource = new EventSource(`/process?${params.toString()}`);
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.error) {
                    const logEntry = document.createElement('div');
                    logEntry.innerHTML = '<span style="color: #ff5252;">❌</span> Error: ' + data.error;
                    logContent.appendChild(logEntry);
                    logContent.scrollTop = logContent.scrollHeight;
                    
                    eventSource.close();
                    processButton.disabled = false;
                    processButton.textContent = originalSummarizeText;
                    return;
                }
                
                if (data.status === 'complete') {
                    eventSource.close();
                    processButton.disabled = false;
                    processButton.textContent = originalSummarizeText;
                    
                    // Add completion message
                    const logEntry = document.createElement('div');
                    logEntry.innerHTML = '<span style="color: #4CAF50;">✓</span> Processing complete!';
                    logContent.appendChild(logEntry);
                    
                    // Automatically trigger download
                    const downloadIframe = document.createElement('iframe');
                    downloadIframe.style.display = 'none';
                    downloadIframe.src = data.file;
                    document.body.appendChild(downloadIframe);
                    setTimeout(() => {
                        document.body.removeChild(downloadIframe);
                    }, 2000);
                } else if (data.status === 'processing') {
                    // Update progress in the original style
                    const logEntry = document.createElement('div');
                    const progress = Math.round((data.current / data.total) * 100);
                    logEntry.innerHTML = '<span style="color: #4CAF50;">✓</span> Processed ' + data.current + ' of ' + data.total + ': ' + data.result;
                    logContent.appendChild(logEntry);
                    logContent.scrollTop = logContent.scrollHeight;
                    
                    // Update progress in button text
                    processButton.textContent = 'Processing... ' + progress + '%';
                }
            };
            
            eventSource.onerror = function(error) {
                console.error('EventSource error:', error);
                eventSource.close();
                
                const logEntry = document.createElement('div');
                logEntry.innerHTML = '<span style="color: #ff5252;">❌</span> Connection error. Please try again.';
                logContent.appendChild(logEntry);
                
                processButton.disabled = false;
                processButton.textContent = originalSummarizeText;
            };
        }

        function updateStats(stats) {
            const statsContainer = document.querySelector('.stats-grid');
            if (!statsContainer) return;

            let html = `
                <div class="stat-box">
                    <h4>Basic Stats</h4>
                    <p>Total Rows: ${stats.row_count}</p>
                    <p>Average Characters: ${stats.mean_chars}</p>
                    <p>Median Characters: ${stats.median_chars}</p>
                    <p>Total Characters: ${stats.total_chars}</p>
                </div>
            `;

            for (const [model, cost] of Object.entries(stats.costs)) {
                html += `
                    <div class="stat-box model-cost">
                        <h5>${cost.display_name}</h5>
                        <div class="cost-grid">
                            <div class="cost-section">
                                <h6>Input Costs (per 1M tokens)</h6>
                                <p>Regular: $${(cost.input_price).toFixed(2)}</p>
                                <p>Cached: $${(cost.cached_input_price).toFixed(2)}</p>
                            </div>
                            <div class="cost-section">
                                <h6>Output Cost (per 1M tokens)</h6>
                                <p>$${(cost.output_price).toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="total-cost">
                            <p>Total Cost (Regular): $${cost.estimated_total_cost}</p>
                            <p>Total Cost (Cached): $${cost.estimated_total_cost_cached}</p>
                        </div>
                    </div>
                `;
            }

            statsContainer.innerHTML = html;
        }

        function showTab(index) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.preview-content').forEach(content => content.classList.remove('active'));
            
            document.querySelectorAll('.tab-button')[index].classList.add('active');
            document.getElementById(`tab-${index}`).classList.add('active');

            // Update prompt preview with new CSV data
            const csvData = document.getElementById(`tab-${index}`).textContent;
            const previewElement = document.querySelector('.prompt-preview .preview-content');
            if (previewElement.textContent !== 'No preview available') {
                const template = document.getElementById('custom-prompt').value;
                updatePromptPreviewWithData(template, csvData);
            }
        }

        function updatePromptTemplate() {
            const select = document.getElementById('template-select');
            const [category, key] = select.value.split('.');
            const selectedTemplate = TEMPLATES[category][key];
            
            if (selectedTemplate) {
                const template = selectedTemplate.template;
                document.getElementById('custom-prompt').value = template;
                
                // Get current CSV data
                const activeTab = document.querySelector('.preview-content.active');
                const csvData = activeTab ? activeTab.textContent : '';
                
                // Update preview with new template
                updatePromptPreviewWithData(template, csvData);

                // Update cost statistics with new template
                updateCostStats(template);
            }
        }

        function updatePromptPreviewWithData(template, csvData) {
            if (!csvData) return;
            
            const preview = template.replace('{csv column input}', csvData);
            const previewElement = document.querySelector('.prompt-preview .preview-content');
            previewElement.innerHTML = preview.replace(csvData, '<span class="csv-data">' + csvData + '</span>');
        }

        function updateCostStats(template) {
            fetch('/update_cost_stats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    template: template || document.getElementById('custom-prompt').value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.stats) {
                    updateStats(data.stats);
                }
            });
        }

        function uploadNewFile() {
            const fileInput = document.getElementById('csv-file');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file first');
                return;
            }

            const formData = new FormData();
            formData.append('csv_file', file);

            fetch('/upload_file', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error uploading file');
                }
            });
        }

        // Add file input change listener
        document.getElementById('csv-file').addEventListener('change', uploadNewFile);

        // Initialize the first preview tab as active and hide non-relevant templates
        document.addEventListener('DOMContentLoaded', function() {
            showTab(0);
            
            // Hide non-relevant templates based on current mode
            const mode = '{{ session.get("mode", "summarize") }}';
            const templateSelect = document.getElementById('template-select');
            
            // Hide all mode-specific options first
            Array.from(templateSelect.options).forEach(option => {
                if (option.classList.contains('mode-specific')) {
                    option.style.display = 'none';
                }
            });
            
            // Show only relevant options
            Array.from(templateSelect.options).forEach(option => {
                const value = option.value;
                if (value === mode || value === 'default' || value === 'job_description') {
                    option.style.display = '';
                }
            });

            // Update cost stats with initial template
            updateCostStats();
        });

        function togglePredictorColumn(element, column) {
            var checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                selectedPredictors.add(column);
                element.classList.add('selected');
            } else {
                selectedPredictors.delete(column);
                element.classList.remove('selected');
            }
            
            updateAnalyzeButton();
        }

        function toggleOutcomeColumn(element, column) {
            var radio = element.querySelector('input[type="radio"]');
            radio.checked = true;
            selectedOutcome = column;
            
            // Update styling for all outcome columns
            document.querySelectorAll('#outcome-columns .column-item').forEach(function(item) {
                item.classList.remove('selected');
            });
            element.classList.add('selected');
            
            // Remove this column from predictors if it was selected
            if (selectedPredictors.has(column)) {
                var predictorElement = document.querySelector('#pred-' + column).parentElement;
                togglePredictorColumn(predictorElement, column);
            }
            
            updateAnalyzeButton();
        }

        function updateAnalyzeButton() {
            var analyzeButton = document.getElementById('analyze-button');
            analyzeButton.disabled = selectedPredictors.size === 0 || !selectedOutcome;
        }

        function runAnalysis() {
            // Show loading spinner
            document.getElementById('analysis-loading').classList.add('active');
            document.getElementById('analysis-results').classList.remove('active');
            
            // Get selected variables
            const data = {
                predictors: Array.from(selectedPredictors),
                outcome: selectedOutcome
            };
            
            // Send analysis request
            fetch('/run_analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Hide loading spinner
                    document.getElementById('analysis-loading').classList.remove('active');
                    document.getElementById('analysis-results').classList.add('active');
                    
                    // Display correlation table
                    displayCorrelationTable(data.correlations);
                    
                    // Display distribution plots
                    displayDistributions(data.distributions);

                    // Display scatter plots
                    displayScatterPlots(data.scatter_data, selectedOutcome);
                } else {
                    alert('Error running analysis: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error running analysis. Please try again.');
            })
            .finally(() => {
                document.getElementById('analysis-loading').classList.remove('active');
            });
        }

        function displayCorrelationTable(correlations) {
            // Display Pearson correlations with outcome
            const pearsonContainer = document.getElementById('pearson-correlation');
            const predictorCorrelations = [];
            
            selectedPredictors.forEach(predictor => {
                const correlation = correlations[`${predictor}-${selectedOutcome}`] || correlations[`${selectedOutcome}-${predictor}`] || 0;
                predictorCorrelations.push({
                    predictor,
                    correlation
                });
            });
            
            // Sort by absolute correlation value
            predictorCorrelations.sort((a, b) => Math.abs(b.correlation) - Math.abs(a.correlation));
            
            let pearsonHtml = '';
            predictorCorrelations.forEach(({ predictor, correlation }) => {
                const absCorrelation = Math.abs(correlation);
                const barWidth = Math.min(Math.abs(correlation * 100), 100);
                const formattedCorr = correlation.toFixed(3);
                
                pearsonHtml += `
                    <div class="pearson-bar">
                        <div class="pearson-label">${predictor}</div>
                        <div class="pearson-bar-graph">
                            <div class="pearson-bar-fill ${correlation >= 0 ? 'positive' : 'negative'}" 
                                 style="width: ${barWidth}%"></div>
                        </div>
                        <div class="pearson-value">${formattedCorr}</div>
                    </div>
                `;
            });
            
            pearsonContainer.innerHTML = pearsonHtml;
            
            // Display full correlation matrix
            const tableContainer = document.getElementById('correlation-table');
            const variables = [...selectedPredictors, selectedOutcome];
            
            let html = '<table class="correlation-table"><tr><th>Variable</th>';
            variables.forEach(v => {
                html += `<th>${v}</th>`;
            });
            html += '</tr>';
            
            variables.forEach(v1 => {
                html += `<tr><td><strong>${v1}</strong></td>`;
                variables.forEach(v2 => {
                    const correlation = correlations[`${v1}-${v2}`] || correlations[`${v2}-${v1}`] || (v1 === v2 ? 1 : 0);
                    const formattedCorr = correlation.toFixed(3);
                    const color = getCorrelationColor(correlation);
                    html += `<td class="correlation-value" style="background-color: ${color}">${formattedCorr}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            
            tableContainer.innerHTML = html;
        }

        function getCorrelationColor(correlation) {
            const absCorr = Math.abs(correlation);
            const alpha = absCorr * 0.5; // Adjust color intensity
            return correlation >= 0 
                ? `rgba(0, 255, 0, ${alpha})` // Green for positive correlations
                : `rgba(255, 0, 0, ${alpha})`; // Red for negative correlations
        }

        function displayDistributions(distributions) {
            const container = document.getElementById('distribution-grid');
            container.innerHTML = ''; // Clear previous plots
            
            // Create a plot for each predictor variable
            selectedPredictors.forEach(variable => {
                const plotData = distributions[variable];
                if (plotData) {
                    const plotDiv = document.createElement('div');
                    plotDiv.className = 'distribution-plot';
                    plotDiv.innerHTML = `
                        <h4>${variable} Distribution</h4>
                        <div id="plot-${variable}" style="height: 400px;"></div>  <!-- Added fixed height -->
                        <div style="margin-top: 10px; font-size: 0.9em;">
                            <strong>Statistics:</strong><br>
                            Mean: ${plotData.mean.toFixed(2)}<br>
                            Std Dev: ${plotData.std.toFixed(2)}<br>
                            Min: ${plotData.min.toFixed(2)}<br>
                            Max: ${plotData.max.toFixed(2)}
                        </div>
                    `;
                    container.appendChild(plotDiv);
                    
                    // Calculate number of bins based on data range and Sturges' formula
                    const n = plotData.values.length;
                    const numBins = Math.ceil(Math.log2(n) + 1);
                    
                    // Create the plot using plotly.js with improved styling
                    Plotly.newPlot(`plot-${variable}`, [{
                        x: plotData.values,
                        type: 'histogram',
                        name: variable,
                        nbinsx: numBins,
                        marker: {
                            color: 'rgba(76, 175, 80, 0.6)',
                            line: {
                                color: '#4CAF50',
                                width: 1
                            }
                        }
                    }], {
                        title: {
                            text: `Distribution of ${variable}`,
                            font: {
                                size: 16
                            }
                        },
                        xaxis: {
                            title: variable,
                            tickfont: {
                                size: 12
                            }
                        },
                        yaxis: {
                            title: 'Frequency',
                            tickfont: {
                                size: 12
                            }
                        },
                        bargap: 0.1,
                        margin: {
                            l: 50,
                            r: 20,
                            t: 40,
                            b: 40
                        },
                        height: 400  // Added fixed height
                    }, {
                        responsive: true
                    });
                }
            });
        }

        function displayScatterPlots(scatterData, outcome) {
            const container = document.getElementById('scatter-grid');
            container.innerHTML = ''; // Clear previous plots
            
            // Create a plot for each predictor variable
            Object.entries(scatterData).forEach(([predictor, data]) => {
                const plotDiv = document.createElement('div');
                plotDiv.className = 'scatter-plot';
                plotDiv.innerHTML = `<div id="scatter-${predictor}" style="height: 400px;"></div>`;
                container.appendChild(plotDiv);
                
                // Add small random jitter to y values to show overlapping points
                const jitteredY = data.y.map(y => y + (Math.random() - 0.5) * 0.2);
                
                // Create scatter plot
                const trace = {
                    x: data.x,
                    y: jitteredY,
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Data Points',
                    marker: {
                        color: 'rgba(52, 152, 219, 0.5)',  // Softer blue with transparency
                        size: 8,
                        line: {
                            color: 'rgba(52, 152, 219, 0.8)',
                            width: 1
                        }
                    },
                    hovertemplate: `
                        ${predictor}: %{x}<br>
                        ${outcome}: %{text}<br>
                        <extra></extra>
                    `,
                    text: data.y.map(y => y.toFixed(1))  // Original (non-jittered) y values for hover
                };

                // Calculate LOESS line with improved smoothing
                let traces = [trace];
                if (document.getElementById('show-loess').checked) {
                    const loessTrace = calculateLoessLine(data.x, data.y);
                    traces.push(loessTrace);
                }
                
                // Calculate basic statistics for annotations
                const correlation = calculateCorrelation(data.x, data.y);
                const correlationText = correlation.toFixed(2);
                const relationshipStrength = Math.abs(correlation) < 0.2 ? 'weak' : 
                                          Math.abs(correlation) < 0.4 ? 'moderate' :
                                          'strong';
                const relationshipDirection = correlation > 0 ? 'positive' : 'negative';
                
                Plotly.newPlot(`scatter-${predictor}`, traces, {
                    title: {
                        text: `Relationship between ${predictor} and ${outcome}`,
                        font: { size: 16, color: '#2c3e50' }
                    },
                    xaxis: {
                        title: {
                            text: predictor,
                            font: { size: 14, color: '#2c3e50' }
                        },
                        tickfont: { size: 12 },
                        gridcolor: '#f5f5f5'
                    },
                    yaxis: {
                        title: {
                            text: outcome,
                            font: { size: 14, color: '#2c3e50' }
                        },
                        tickfont: { size: 12 },
                        gridcolor: '#f5f5f5',
                        range: [Math.min(...data.y) - 0.5, Math.max(...data.y) + 0.5]  // Add padding to show jitter
                    },
                    margin: {
                        l: 60,
                        r: 30,
                        t: 50,
                        b: 60
                    },
                    showlegend: true,
                    legend: {
                        x: 0.02,
                        y: 0.98,
                        bgcolor: 'rgba(255, 255, 255, 0.8)'
                    },
                    annotations: [{
                        x: 0.02,
                        y: -0.18,
                        xref: 'paper',
                        yref: 'paper',
                        text: `Correlation: ${correlationText} (${relationshipStrength} ${relationshipDirection} relationship)`,
                        showarrow: false,
                        font: {
                            size: 12,
                            color: '#666'
                        }
                    }],
                    plot_bgcolor: 'white',
                    paper_bgcolor: 'white',
                    height: 400
                }, {
                    responsive: true,
                    displayModeBar: false  // Hide the modebar for cleaner look
                });
            });
        }

        function calculateCorrelation(x, y) {
            const n = x.length;
            const meanX = x.reduce((a, b) => a + b) / n;
            const meanY = y.reduce((a, b) => a + b) / n;
            
            const sdX = Math.sqrt(x.reduce((a, b) => a + Math.pow(b - meanX, 2), 0) / n);
            const sdY = Math.sqrt(y.reduce((a, b) => a + Math.pow(b - meanY, 2), 0) / n);
            
            const covariance = x.reduce((a, b, i) => a + (b - meanX) * (y[i] - meanY), 0) / n;
            
            return covariance / (sdX * sdY);
        }

        function calculateLoessLine(x, y) {
            // Sort x and y values
            const indices = Array.from(Array(x.length).keys());
            indices.sort((a, b) => x[a] - x[b]);
            const sortedX = indices.map(i => x[i]);
            const sortedY = indices.map(i => y[i]);
            
            // Calculate moving average with weighted window
            const windowSize = Math.max(Math.floor(x.length * 0.3), 7); // Increased window size for smoother line
            const smoothedY = [];
            const smoothedX = [];
            
            for (let i = 0; i < sortedX.length - windowSize; i += Math.max(1, Math.floor(windowSize/6))) {
                const windowX = sortedX.slice(i, i + windowSize);
                const windowY = sortedY.slice(i, i + windowSize);
                
                // Calculate weighted average (triangular weights)
                let weightedSum = 0;
                let weightSum = 0;
                for (let j = 0; j < windowSize; j++) {
                    const weight = 1 - Math.abs(j - windowSize/2)/(windowSize/2);
                    weightedSum += windowY[j] * weight;
                    weightSum += weight;
                }
                
                smoothedX.push(windowX[Math.floor(windowSize/2)]);
                smoothedY.push(weightedSum / weightSum);
            }
            
            return {
                x: smoothedX,
                y: smoothedY,
                mode: 'lines',
                type: 'scatter',
                name: 'Trend Line',
                line: {
                    color: 'rgba(231, 76, 60, 0.8)',  // Softer red
                    width: 3,
                    shape: 'spline'  // Make the line smoother
                }
            };
        }

        function toggleLoessLines() {
            const showLoess = document.getElementById('show-loess').checked;
            // Re-run the analysis to update plots
            runAnalysis();
        }

        function updateModeStyles(mode) {
            document.body.setAttribute('data-active-mode', mode);
        }

        // Add to existing scripts at the end of the file
        function showInstructions() {
            document.getElementById('instructionsModal').style.display = 'block';
            document.body.style.overflow = 'hidden';  // Prevent background scrolling
        }

        function hideInstructions() {
            document.getElementById('instructionsModal').style.display = 'none';
            document.body.style.overflow = 'auto';  // Restore scrolling
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('instructionsModal');
            if (event.target == modal) {
                hideInstructions();
            }
        }
    </script>

    <!-- Add Plotly.js for distribution plots -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</body>
</html> 