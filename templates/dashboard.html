<!DOCTYPE html>
<html>
<head>
    <title>LLM Classifier Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .settings {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .toggle-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 20px 0;
        }
        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
        }
        .button:hover {
            background-color: #45a049;
        }
        select, input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        textarea {
            width: 100%;
            min-height: 150px;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .step-container {
            text-align: center;
            padding: 40px;
            background: #f5f5f5;
            border-radius: 8px;
            margin: 40px auto;
            max-width: 600px;
        }
        .error-message {
            color: #d32f2f;
            margin: 10px 0;
            display: none;
        }
        .steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .step {
            padding: 10px 20px;
            margin: 0 10px;
            background: #ddd;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .step.active {
            background: #4CAF50;
            color: white;
        }
        .step.completed {
            background: #81C784;
            color: white;
        }
        .stats-container {
            margin: 20px 0;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .stat-box {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .stat-box h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .stat-box p {
            margin: 5px 0;
            color: #495057;
        }
        
        .model-cost {
            margin: 10px 0;
            padding: 10px;
            background: #fff;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        
        .model-cost h5 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }
        
        .cost-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .cost-section {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
        }
        
        .cost-section h6 {
            margin: 0 0 5px 0;
            color: #2c3e50;
            font-size: 0.9em;
        }
        
        .cost-section p {
            margin: 3px 0;
            font-size: 0.9em;
        }
        
        .total-cost {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
            text-align: right;
        }
        
        .total-cost p {
            margin: 5px 0;
        }
        
        select {
            font-size: 0.9em;
            padding: 8px;
        }

        .content-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
            min-height: 600px;
        }

        .preview-box {
            display: flex;
            flex-direction: column;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: auto;
        }

        .preview-content {
            display: none;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            height: 600px;  /* Doubled from 300px to 600px */
            overflow-y: auto;
            font-size: 0.9em;
            border: 1px solid #e9ecef;
        }

        .preview-content.active {
            display: block;
        }

        .prompt-preview .preview-content {
            display: block;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #f0f0f0;
            cursor: pointer;
        }

        .tab-button.active {
            background: #4CAF50;
            color: white;
        }

        .template-controls {
            margin-bottom: 15px;
        }

        .prompt-preview {
            margin-top: 20px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .preview-content .csv-data {
            font-style: italic;
            color: #4CAF50;
        }

        .settings-top {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: start;
        }

        .settings-top > div {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .settings-top label {
            font-weight: 500;
            color: #2c3e50;
        }

        .settings-top input,
        .settings-top select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .settings-top .button {
            align-self: flex-start;
            margin-top: 5px;
        }

        .settings-top .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .settings-top .input-group input {
            flex: 1;
        }

        .csv-file-display {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .csv-file-name {
            font-family: monospace;
            color: #2c3e50;
        }

        .right-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .flow-arrow {
            position: relative;
            height: 60px;  /* Increased height */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4CAF50;
            font-size: 36px;  /* Larger font size */
            margin: 10px 0;
        }

        .flow-arrow::after {
            content: '↓';
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);  /* Add shadow */
            animation: float 2s ease-in-out infinite;  /* Add floating animation */
        }

        .horizontal-arrow {
            position: absolute;
            left: -50px;  /* Move further out */
            top: 50%;
            transform: translateY(-50%);
            color: #4CAF50;
            font-size: 36px;  /* Larger font size */
            width: 50px;  /* Fixed width */
            height: 50px;  /* Fixed height */
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);  /* Add shadow */
            animation: pulse 2s ease-in-out infinite;  /* Add pulse animation */
        }

        .horizontal-arrow::after {
            content: '→';
            font-weight: bold;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes pulse {
            0%, 100% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.1); }
        }

        /* Custom scrollbar styling */
        .preview-content::-webkit-scrollbar {
            width: 8px;
        }

        .preview-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .preview-content::-webkit-scrollbar-thumb {
            background: #4CAF50;
            border-radius: 4px;
        }

        .preview-content::-webkit-scrollbar-thumb:hover {
            background: #45a049;
        }

        .mode-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 30px 0;
        }

        .mode-button {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: #e6f3ff;  /* Light blue background */
            color: #2196F3;  /* Blue text */
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .mode-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            background-color: #bbdefb;  /* Slightly darker blue on hover */
        }

        .mode-button.active {
            background-color: #2196F3;  /* Solid blue when active */
            color: white;
        }

        .process-button-container {
            display: flex;
            justify-content: center;
            margin: 40px 0;
        }

        .process-button {
            padding: 20px 40px;
            font-size: 1.2em;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .process-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            background-color: #45a049;
        }

        .template-box {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .log-container {
            margin: 20px 0;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .log-container h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        #log-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        #log-content div {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #e9ecef;
        }

        #log-content a {
            color: #2196F3;
            text-decoration: none;
        }

        #log-content a:hover {
            text-decoration: underline;
        }

        #log-content span {
            margin-right: 8px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>LLM Classifier Dashboard</h1>

    <!-- Progress Steps -->
    <div class="steps">
        <div class="step {% if step == 'upload' %}active{% elif step in ['select_column', 'dashboard'] %}completed{% endif %}">
            1. Upload CSV
        </div>
        <div class="step {% if step == 'select_column' %}active{% elif step == 'dashboard' %}completed{% endif %}">
            2. Select Column
        </div>
        <div class="step {% if step == 'dashboard' %}active{% endif %}">
            3. Configure & Process
        </div>
    </div>

    {% if step == 'upload' %}
    <div class="step-container">
        <h2>Upload CSV File</h2>
        <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
            <input type="file" name="csv_file" accept=".csv" required>
            <button type="submit" class="button">Upload</button>
        </form>
    </div>
    {% endif %}

    {% if step == 'select_column' %}
    <div class="step-container">
        <h2>Select Column to Process</h2>
        <select id="column-select">
            {% for column in columns %}
            <option value="{{ column }}">{{ column }}</option>
            {% endfor %}
        </select>
        <button onclick="updateColumn()" class="button">Continue</button>
    </div>
    {% endif %}

    {% if step == 'dashboard' %}
    <!-- Top Section: API Key and Model Selection -->
    <div class="settings-top">
        <div>
            <label>API Key:</label>
            <div class="input-group">
                <input type="text" id="api-key" value="{{ api_key }}" placeholder="Enter OpenAI API Key">
                <button onclick="updateApiKey()" class="button">Update API Key</button>
                {% if connection_error %}
                <div class="error-message">{{ error_message }}</div>
                {% endif %}
            </div>
        </div>
        <div>
            <label>Current CSV File:</label>
            <div class="csv-file-display">
                <span class="csv-file-name">{{ session.get('csv_path', '').split('/')[-1] }}</span>
                <input type="file" id="csv-file" accept=".csv" style="display: none;">
                <button onclick="document.getElementById('csv-file').click()" class="button">Change File</button>
            </div>
        </div>
        <div>
            <label>Column:</label>
            <div class="input-group">
                <select id="column-select" onchange="updateColumn()">
                    {% for column in columns %}
                    <option value="{{ column }}" {% if column == selected_column %}selected{% endif %}>{{ column }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div>
            <label>Model:</label>
            <select id="model-select" onchange="updateModel()">
                {% for model_id, info in models.items() %}
                <option value="{{ model_id }}" {% if model == model_id %}selected{% endif %}>
                    {{ info.display_name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Mode Selection -->
    <div class="mode-buttons">
        <button class="mode-button {% if session.get('mode', 'summarize') == 'summarize' %}active{% endif %}" 
                onclick="updateMode('summarize')">Summarization Mode</button>
        <button class="mode-button {% if session.get('mode') == 'classify' %}active{% endif %}" 
                onclick="updateMode('classify')">Classification Mode</button>
    </div>

    <!-- Dataset Stats -->
    <div class="stats-container">
        <h2>Dataset Statistics</h2>
        {% if stats %}
        <div class="stats-grid">
            <div class="stat-box">
                <h4>Basic Stats</h4>
                <p>Total Rows: {{ stats.row_count }}</p>
                <p>Average Characters: {{ stats.mean_chars }}</p>
                <p>Median Characters: {{ stats.median_chars }}</p>
                <p>Total Characters: {{ stats.total_chars }}</p>
            </div>
            
            {% for model, cost in stats.costs.items() %}
            <div class="stat-box model-cost">
                <h5>{{ cost.display_name }}</h5>
                <div class="cost-grid">
                    <div class="cost-section">
                        <h6>Input Costs (per 1M tokens)</h6>
                        <p>Regular: ${{ "%.2f"|format(cost.input_price) }}</p>
                        <p>Cached: ${{ "%.2f"|format(cost.cached_input_price) }}</p>
                    </div>
                    <div class="cost-section">
                        <h6>Output Cost (per 1M tokens)</h6>
                        <p>${{ "%.2f"|format(cost.output_price) }}</p>
                    </div>
                </div>
                <div class="total-cost">
                    <p>Total Cost (Regular): ${{ cost.estimated_total_cost }}</p>
                    <p>Total Cost (Cached): ${{ cost.estimated_total_cost_cached }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Content Layout -->
    <div class="content-layout">
        <!-- Left Side: Column Preview with Tabs -->
        <div class="preview-box">
            <h3>CSV Data Preview</h3>
            <div class="tabs">
                {% for i in range(5) %}
                <button class="tab-button {% if loop.first %}active{% endif %}" onclick="showTab({{ i }})">Entry {{ i + 1 }}</button>
                {% endfor %}
            </div>
            {% if preview_data %}
                {% for i in range(5) %}
                <div class="preview-content {% if loop.first %}active{% endif %}" id="tab-{{ i }}">
                    {{ preview_data[i] if preview_data|length > i else 'No data available' }}
                </div>
                {% endfor %}
            {% endif %}
        </div>

        <!-- Right Side: Template and Preview -->
        <div class="right-column">
            <!-- Template Box -->
            <div class="template-box">
                <h3>Prompt Template</h3>
                <div class="horizontal-arrow"></div>
                <div class="template-controls">
                    <select id="template-select" onchange="updatePromptTemplate()">
                        {% if session.get('mode') == 'classify' %}
                            {% for key, template in sample_prompts.classification.items() %}
                            <option value="classification.{{ key }}">
                                {{ template.name }}
                            </option>
                            {% endfor %}
                        {% else %}
                            {% for key, template in sample_prompts.summarization.items() %}
                            <option value="summarization.{{ key }}">
                                {{ template.name }}
                            </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <textarea id="custom-prompt">{{ prompt_template }}</textarea>
            </div>

            <!-- Flow Arrow -->
            <div class="flow-arrow"></div>

            <!-- Preview Box -->
            <div class="prompt-preview">
                <h3>Full Prompt Preview</h3>
                <div class="preview-content">
                    {{ prompt_preview|replace(preview_data[0] if preview_data else '', '<span class="csv-data">' + (preview_data[0] if preview_data else '') + '</span>')|safe if prompt_preview else 'No preview available' }}
                </div>
            </div>
        </div>
    </div>

    <!-- Process Button -->
    <div class="process-button-container">
        <button id="process-button" class="process-button" onclick="processData('summarize')">Summarize Data</button>
        <button id="classify-button" class="process-button" onclick="processData('classify')" style="margin-left: 20px; background-color: #2196F3;">Classify Data</button>
    </div>

    <!-- Processing Log -->
    <div class="log-container">
        <h3>Processing Log</h3>
        <div id="log-content"></div>
    </div>

    <!-- Classification Prompt Dialog -->
    <div id="classification-prompt" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; max-width: 500px; width: 90%;">
        <h3 style="margin-top: 0;">Proceed to Classification?</h3>
        <p>Would you like to classify the summarized content?</p>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button onclick="closeClassificationPrompt()" style="padding: 8px 16px; border: 1px solid #ddd; background: #f5f5f5; border-radius: 4px; cursor: pointer;">No, Skip</button>
            <button onclick="proceedToClassification()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Yes, Proceed</button>
        </div>
    </div>
    {% endif %}

    <script>
        var TEMPLATES = {{ sample_prompts|tojson|safe }};

        function updateApiKey() {
            const apiKey = document.getElementById('api-key').value;
            fetch('/update_api_key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Error updating API key: ' + data.message);
                }
            });
        }

        function updateModel() {
            const model = document.getElementById('model-select').value;
            fetch('/update_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ model: model })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (data.stats) {
                        updateStats(data.stats);
                    }
                } else {
                    alert('Error updating model: ' + data.message);
                }
            });
        }

        function updateMode(mode) {
            fetch('/update_mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ mode: mode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update mode button styling
                    document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelector(`.mode-button[onclick="updateMode('${mode}')"]`).classList.add('active');
                    
                    // Update template select options based on mode
                    const templateSelect = document.getElementById('template-select');
                    templateSelect.innerHTML = '';
                    
                    // Add new options based on mode
                    const modeTemplates = mode === 'classify' ? TEMPLATES.classification : TEMPLATES.summarization;
                    for (const [key, template] of Object.entries(modeTemplates)) {
                        const option = document.createElement('option');
                        option.value = `${mode === 'classify' ? 'classification' : 'summarization'}.${key}`;
                        option.textContent = template.name;
                        templateSelect.appendChild(option);
                    }
                    
                    // Set first template as selected and update
                    if (templateSelect.options.length > 0) {
                        templateSelect.selectedIndex = 0;
                        updatePromptTemplate();
                    }

                    // Update process button text
                    const processButton = document.getElementById('process-button');
                    const classifyButton = document.getElementById('classify-button');
                    if (mode === 'classify') {
                        processButton.style.display = 'none';
                        classifyButton.style.display = 'inline-block';
                    } else {
                        processButton.style.display = 'inline-block';
                        classifyButton.style.display = 'none';
                    }

                    // Reload the page to ensure all templates are properly updated
                    location.reload();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function updateColumn() {
            const column = document.getElementById('column-select').value;
            fetch('/update_column', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ column: column })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                }
            });
        }

        function processData(mode) {
            const processButton = document.getElementById('process-button');
            const classifyButton = document.getElementById('classify-button');
            const logContent = document.getElementById('log-content');
            const customPrompt = document.getElementById('custom-prompt').value;
            const originalSummarizeText = processButton.textContent;
            const originalClassifyText = classifyButton ? classifyButton.textContent : '';
            
            // Disable buttons during processing
            processButton.disabled = true;
            if (classifyButton) {
                classifyButton.disabled = true;
            }
            processButton.textContent = 'Processing...';
            if (classifyButton) {
                classifyButton.textContent = 'Processing...';
            }
            
            // Clear previous log
            logContent.innerHTML = '';
            
            // Create EventSource for server-sent events
            const params = new URLSearchParams({
                custom_prompt: customPrompt,
                mode: mode
            });
            
            const eventSource = new EventSource(`/process?${params.toString()}`);
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.error) {
                    const logEntry = document.createElement('div');
                    logEntry.innerHTML = '<span style="color: #ff5252;">❌</span> Error: ' + data.error;
                    logContent.appendChild(logEntry);
                    logContent.scrollTop = logContent.scrollHeight;
                    
                    eventSource.close();
                    processButton.disabled = false;
                    processButton.textContent = originalSummarizeText;
                    if (classifyButton) {
                        classifyButton.disabled = false;
                        classifyButton.textContent = originalClassifyText;
                    }
                    return;
                }
                
                if (data.status === 'complete') {
                    eventSource.close();
                    processButton.disabled = false;
                    processButton.textContent = originalSummarizeText;
                    if (classifyButton) {
                        classifyButton.disabled = false;
                        classifyButton.textContent = originalClassifyText;
                    }
                    
                    // Add completion message
                    const logEntry = document.createElement('div');
                    logEntry.innerHTML = '<span style="color: #4CAF50;">✓</span> Processing complete!';
                    logContent.appendChild(logEntry);
                    
                    // Store output path for potential classification
                    if (data.output_path) {
                        const previewContent = document.querySelector('.prompt-preview .preview-content');
                        if (previewContent) {
                            previewContent.setAttribute('data-output-path', data.output_path);
                        }
                    }
                    
                    // Automatically trigger download
                    const downloadIframe = document.createElement('iframe');
                    downloadIframe.style.display = 'none';
                    downloadIframe.src = data.file;
                    document.body.appendChild(downloadIframe);
                    setTimeout(() => {
                        document.body.removeChild(downloadIframe);
                    }, 2000);
                    
                    // If this was a summarization and classification is offered
                    if (data.offer_classification) {
                        showClassificationPrompt();
                    }
                } else if (data.status === 'processing') {
                    // Update progress in the original style
                    const logEntry = document.createElement('div');
                    const progress = Math.round((data.current / data.total) * 100);
                    logEntry.innerHTML = '<span style="color: #4CAF50;">✓</span> Processed ' + data.current + ' of ' + data.total + ': ' + data.result;
                    logContent.appendChild(logEntry);
                    logContent.scrollTop = logContent.scrollHeight;
                    
                    // Update progress in button text
                    processButton.textContent = 'Processing... ' + progress + '%';
                    if (classifyButton) {
                        classifyButton.textContent = 'Processing... ' + progress + '%';
                    }
                }
            };
            
            eventSource.onerror = function(error) {
                console.error('EventSource error:', error);
                eventSource.close();
                
                const logEntry = document.createElement('div');
                logEntry.innerHTML = '<span style="color: #ff5252;">❌</span> Connection error. Please try again.';
                logContent.appendChild(logEntry);
                
                processButton.disabled = false;
                processButton.textContent = originalSummarizeText;
                if (classifyButton) {
                    classifyButton.disabled = false;
                    classifyButton.textContent = originalClassifyText;
                }
            };
        }

        function updateStats(stats) {
            const statsContainer = document.querySelector('.stats-grid');
            if (!statsContainer) return;

            let html = `
                <div class="stat-box">
                    <h4>Basic Stats</h4>
                    <p>Total Rows: ${stats.row_count}</p>
                    <p>Average Characters: ${stats.mean_chars}</p>
                    <p>Median Characters: ${stats.median_chars}</p>
                    <p>Total Characters: ${stats.total_chars}</p>
                </div>
            `;

            for (const [model, cost] of Object.entries(stats.costs)) {
                html += `
                    <div class="stat-box model-cost">
                        <h5>${cost.display_name}</h5>
                        <div class="cost-grid">
                            <div class="cost-section">
                                <h6>Input Costs (per 1M tokens)</h6>
                                <p>Regular: $${(cost.input_price).toFixed(2)}</p>
                                <p>Cached: $${(cost.cached_input_price).toFixed(2)}</p>
                            </div>
                            <div class="cost-section">
                                <h6>Output Cost (per 1M tokens)</h6>
                                <p>$${(cost.output_price).toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="total-cost">
                            <p>Total Cost (Regular): $${cost.estimated_total_cost}</p>
                            <p>Total Cost (Cached): $${cost.estimated_total_cost_cached}</p>
                        </div>
                    </div>
                `;
            }

            statsContainer.innerHTML = html;
        }

        function showTab(index) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.preview-content').forEach(content => content.classList.remove('active'));
            
            document.querySelectorAll('.tab-button')[index].classList.add('active');
            document.getElementById(`tab-${index}`).classList.add('active');

            // Update prompt preview with new CSV data
            const csvData = document.getElementById(`tab-${index}`).textContent;
            const previewElement = document.querySelector('.prompt-preview .preview-content');
            if (previewElement.textContent !== 'No preview available') {
                const template = document.getElementById('custom-prompt').value;
                updatePromptPreviewWithData(template, csvData);
            }
        }

        function updatePromptTemplate() {
            const select = document.getElementById('template-select');
            const [category, key] = select.value.split('.');
            const selectedTemplate = TEMPLATES[category][key];
            
            if (selectedTemplate) {
                const template = selectedTemplate.template;
                document.getElementById('custom-prompt').value = template;
                
                // Get current CSV data
                const activeTab = document.querySelector('.preview-content.active');
                const csvData = activeTab ? activeTab.textContent : '';
                
                // Update preview with new template
                updatePromptPreviewWithData(template, csvData);

                // Update cost statistics with new template
                updateCostStats(template);
            }
        }

        function updatePromptPreviewWithData(template, csvData) {
            if (!csvData) return;
            
            const preview = template.replace('{csv column input}', csvData);
            const previewElement = document.querySelector('.prompt-preview .preview-content');
            previewElement.innerHTML = preview.replace(csvData, '<span class="csv-data">' + csvData + '</span>');
        }

        function updateCostStats(template) {
            fetch('/update_cost_stats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    template: template || document.getElementById('custom-prompt').value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.stats) {
                    updateStats(data.stats);
                }
            });
        }

        function uploadNewFile() {
            const fileInput = document.getElementById('csv-file');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file first');
                return;
            }

            const formData = new FormData();
            formData.append('csv_file', file);

            fetch('/upload_file', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error uploading file');
                }
            });
        }

        // Add file input change listener
        document.getElementById('csv-file').addEventListener('change', uploadNewFile);

        // Initialize the first preview tab as active and hide non-relevant templates
        document.addEventListener('DOMContentLoaded', function() {
            showTab(0);
            
            // Hide non-relevant templates based on current mode
            const mode = '{{ session.get("mode", "summarize") }}';
            const templateSelect = document.getElementById('template-select');
            
            // Hide all mode-specific options first
            Array.from(templateSelect.options).forEach(option => {
                if (option.classList.contains('mode-specific')) {
                    option.style.display = 'none';
                }
            });
            
            // Show only relevant options
            Array.from(templateSelect.options).forEach(option => {
                const value = option.value;
                if (value === mode || value === 'default' || value === 'job_description') {
                    option.style.display = '';
                }
            });

            // Update cost stats with initial template
            updateCostStats();
        });

        function showClassificationPrompt() {
            document.getElementById('classification-prompt').style.display = 'block';
        }

        function closeClassificationPrompt() {
            document.getElementById('classification-prompt').style.display = 'none';
        }

        function proceedToClassification() {
            document.getElementById('classification-prompt').style.display = 'none';
            const previewContent = document.querySelector('.prompt-preview .preview-content');
            const outputPath = previewContent ? previewContent.getAttribute('data-output-path') : null;
            
            if (!outputPath) {
                console.error('No output path found');
                return;
            }
            
            fetch('/store_summary_path', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ output_path: outputPath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateMode('classification');
                } else {
                    console.error('Error storing summary path:', data.message);
                }
            })
            .catch(error => console.error('Error:', error));
            
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html> 